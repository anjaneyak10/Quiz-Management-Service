


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > QuizService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.example.quizmanagementservice.Services</a>
</div>

<h1>Coverage Summary for Class: QuizService (com.example.quizmanagementservice.Services)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">QuizService</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    77.8%
  </span>
  <span class="absValue">
    (7/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    65.4%
  </span>
  <span class="absValue">
    (70/107)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.example.quizmanagementservice.Services;
&nbsp;
&nbsp;import com.example.quizmanagementservice.CustomException;
&nbsp;import com.example.quizmanagementservice.Dao.QuizSubmissionDao;
&nbsp;import com.example.quizmanagementservice.Dao.SubmissionStatusDao;
&nbsp;import com.example.quizmanagementservice.Model.Constants;
&nbsp;import com.example.quizmanagementservice.Model.QuizSubmission;
&nbsp;import com.example.quizmanagementservice.Resources.QuizResource;
&nbsp;import jakarta.persistence.EntityManager;
&nbsp;import org.json.JSONObject;
&nbsp;import org.slf4j.Logger;
&nbsp;import org.slf4j.LoggerFactory;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.http.*;
&nbsp;import org.springframework.stereotype.Indexed;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.util.StringUtils;
&nbsp;import org.springframework.web.client.RestTemplate;
&nbsp;
&nbsp;import java.util.List;
&nbsp;
&nbsp;@Service
<b class="fc">&nbsp;public class QuizService {</b>
&nbsp;
<b class="fc">&nbsp;    Logger logger = LoggerFactory.getLogger(QuizService.class);</b>
&nbsp;
&nbsp;    @Autowired
&nbsp;    private QuizSubmissionDao quizSubmissionDao;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private SubmissionStatusDao submissionStatusDao;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private EntityManager entityManager;
&nbsp;
&nbsp;    public int submitQuiz(String authToken,QuizSubmission submissionData) throws Exception {
<b class="fc">&nbsp;        if (null == submissionData) {</b>
<b class="fc">&nbsp;            throw new CustomException(new Exception(&quot;submission data is null&quot;), HttpStatus.BAD_REQUEST);</b>
&nbsp;        }
<b class="fc">&nbsp;        if (null == submissionData.getCourseId() || submissionData.getCourseId() == 0) {</b>
<b class="nc">&nbsp;            throw new CustomException(new Exception(&quot;course id is null&quot;), HttpStatus.BAD_REQUEST);</b>
&nbsp;        }
<b class="fc">&nbsp;        if (null == submissionData.getModuleId() || submissionData.getModuleId() == 0) {</b>
<b class="nc">&nbsp;            throw new CustomException(new Exception(&quot;module id is null&quot;), HttpStatus.BAD_REQUEST);</b>
&nbsp;        }
&nbsp;//        if (!StringUtils.hasText(submissionData.getSubmissionText())) {
&nbsp;//            throw new CustomException(new Exception(&quot;submissionText is null/empty&quot;), HttpStatus.BAD_REQUEST);
&nbsp;//        }
<b class="fc">&nbsp;        JSONObject userObj = getUserDetailsFromToken(authToken);</b>
<b class="fc">&nbsp;        if (null == userObj || userObj.isEmpty()){</b>
<b class="nc">&nbsp;            throw new CustomException(new Exception(&quot;User not Authorised&quot;), HttpStatus.UNAUTHORIZED);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        JSONObject courseModuleObj = getModuleDetailsByModuleAndCourseId(submissionData.getModuleId(),</b>
<b class="fc">&nbsp;                submissionData.getCourseId(),authToken);</b>
<b class="fc">&nbsp;        if (null == courseModuleObj || courseModuleObj.isEmpty()){</b>
<b class="nc">&nbsp;            throw new CustomException(new Exception(&quot;Course and Module with id&#39;s don&#39;t exist&quot;), HttpStatus.NOT_FOUND);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        JSONObject isQuizSubmissionPossible = isQuizSubmissionPossible(submissionData.getModuleId(),</b>
<b class="fc">&nbsp;                submissionData.getCourseId(),userObj.getInt(&quot;id&quot;));</b>
<b class="fc">&nbsp;        if (null != isQuizSubmissionPossible &amp;&amp; !isQuizSubmissionPossible.isEmpty()){</b>
<b class="fc">&nbsp;            if (!isQuizSubmissionPossible.getBoolean(&quot;isQuizSubmissionPossible&quot;)){</b>
<b class="nc">&nbsp;                throw new CustomException(new Exception(&quot;Quiz already submitted/graded&quot;), HttpStatus.BAD_REQUEST);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        submissionData.setMarksObtained(null);</b>
<b class="fc">&nbsp;        submissionData.setStudentId(userObj.getInt(&quot;id&quot;));</b>
&nbsp;
<b class="fc">&nbsp;        submissionData.setSubmissionStatusId(submissionStatusDao.findByName(Constants.NOT_GRADED).getId());</b>
<b class="fc">&nbsp;        submissionData.setTotalMarks(100);</b>
&nbsp;
<b class="fc">&nbsp;        QuizSubmission quizSubmission = quizSubmissionDao.save(submissionData);</b>
&nbsp;
<b class="fc">&nbsp;        return quizSubmission.getId();</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    public JSONObject getUserDetailsFromToken(String token) {
<b class="nc">&nbsp;        final String uri = &quot;http://&quot; + Constants.AWS_IP + &quot;:8081/auth&quot;;</b>
&nbsp;
<b class="nc">&nbsp;        RestTemplate restTemplate = new RestTemplate();</b>
<b class="nc">&nbsp;        HttpHeaders headers = new HttpHeaders();</b>
<b class="nc">&nbsp;        headers.add(&quot;Authorization&quot;, token);</b>
&nbsp;
<b class="nc">&nbsp;        HttpEntity&lt;String&gt; entity = new HttpEntity&lt;&gt;(null, headers);</b>
&nbsp;
&nbsp;
&nbsp;        try {
<b class="nc">&nbsp;            ResponseEntity&lt;String&gt; res = restTemplate.exchange(uri, HttpMethod.GET, entity, String.class);</b>
<b class="nc">&nbsp;            String resBody = res.getBody();</b>
<b class="nc">&nbsp;            JSONObject jsonObject = new JSONObject(resBody);</b>
<b class="nc">&nbsp;            return jsonObject;</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            logger.error(&quot;Error in API for auth!&quot;);</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public JSONObject isQuizSubmissionPossible(int moduleId, int courseId, int studentId) throws Exception {
<b class="fc">&nbsp;        if (courseId == 0 || moduleId == 0 || studentId == 0){</b>
<b class="fc">&nbsp;            throw new CustomException(new Exception(&quot;Invalid courseId/moduleId/studentId&quot;), HttpStatus.BAD_REQUEST);</b>
&nbsp;        }
<b class="fc">&nbsp;        QuizSubmission quizSubmission = quizSubmissionDao.</b>
<b class="fc">&nbsp;                findQuizSubmissionByCourseIdAndAndModuleIdAndStudentIdLatest(moduleId,courseId,studentId);</b>
<b class="fc">&nbsp;        JSONObject res = new JSONObject();</b>
<b class="fc">&nbsp;        res.put(&quot;isQuizSubmissionPossible&quot;,true);</b>
<b class="fc">&nbsp;        if (quizSubmission != null &amp;&amp; quizSubmission.getSubmissionStatusId() == 2){</b>
<b class="fc">&nbsp;            res.put(&quot;isQuizSubmissionPossible&quot;,false);</b>
<b class="fc">&nbsp;            res.put(&quot;quizSubmission&quot;,quizSubmission);</b>
&nbsp;        }
<b class="fc">&nbsp;        return res;</b>
&nbsp;    }
&nbsp;
&nbsp;    public List&lt;QuizSubmission&gt; getQuizSubmissionsForGrading(String authToken, int moduleId, int courseId) throws Exception {
<b class="fc">&nbsp;        if (courseId == 0 || moduleId == 0 ){</b>
<b class="fc">&nbsp;            throw new CustomException(new Exception(&quot;Invalid courseId/moduleId/studentId&quot;), HttpStatus.BAD_REQUEST);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        JSONObject userObj = getUserDetailsFromToken(authToken);</b>
<b class="fc">&nbsp;        if (null == userObj || userObj.isEmpty()){</b>
<b class="nc">&nbsp;            throw new CustomException(new Exception(&quot;User not Authorised&quot;), HttpStatus.UNAUTHORIZED);</b>
&nbsp;        }
<b class="fc">&nbsp;        if(userObj.getInt(&quot;roleId&quot;) != 2){</b>
<b class="fc">&nbsp;            throw new CustomException(new Exception(&quot;Students not authorised to view submissions&quot;), HttpStatus.UNAUTHORIZED);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        List&lt;QuizSubmission&gt; quizSubmissionList = quizSubmissionDao.</b>
<b class="fc">&nbsp;                findQuizSubmissionsByCourseIdAndAndModuleIdLatest(moduleId,courseId);</b>
&nbsp;
<b class="fc">&nbsp;        logger.info(&quot;quizSubmissionList : {}&quot;,quizSubmissionList);</b>
&nbsp;
<b class="fc">&nbsp;        quizSubmissionList.forEach(quizSubmission -&gt; {</b>
<b class="fc">&nbsp;            JSONObject studentDetails = getUserDetailsFromUserId(quizSubmission.getStudentId());</b>
<b class="fc">&nbsp;            logger.info(&quot;student details : {}&quot;,studentDetails);</b>
<b class="fc">&nbsp;            if (null != studentDetails) {</b>
<b class="nc">&nbsp;                quizSubmission.setUserDetails(studentDetails.toMap());</b>
&nbsp;            }
&nbsp;        });
<b class="fc">&nbsp;        return quizSubmissionList;</b>
&nbsp;    }
&nbsp;
&nbsp;    public JSONObject postQuizMarks(String authToken, int submissionId, int marksObtained) throws Exception {
<b class="fc">&nbsp;        if(submissionId == 0){</b>
<b class="fc">&nbsp;            throw new CustomException(new Exception(&quot;submission id is null&quot;), HttpStatus.BAD_REQUEST);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        JSONObject userObj = getUserDetailsFromToken(authToken);</b>
<b class="fc">&nbsp;        if (null == userObj || userObj.isEmpty()){</b>
<b class="nc">&nbsp;            throw new CustomException(new Exception(&quot;User not Authorised&quot;), HttpStatus.UNAUTHORIZED);</b>
&nbsp;        }
<b class="fc">&nbsp;        if(userObj.getInt(&quot;roleId&quot;) != 2){</b>
<b class="fc">&nbsp;            throw new CustomException(new Exception(&quot;Students not authorised to grade&quot;), HttpStatus.UNAUTHORIZED);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        QuizSubmission alreadySubmittedData = entityManager.find(QuizSubmission.class, submissionId);</b>
<b class="fc">&nbsp;        if (null == alreadySubmittedData){</b>
<b class="fc">&nbsp;            throw new CustomException(new Exception(&quot;No submission found with id&quot;), HttpStatus.NOT_FOUND);</b>
&nbsp;        }
<b class="fc">&nbsp;        if (alreadySubmittedData.getSubmissionStatusId() == 2){</b>
<b class="fc">&nbsp;            throw new CustomException(new Exception(&quot;Quiz already graded!&quot;), HttpStatus.BAD_REQUEST);</b>
&nbsp;        }
<b class="fc">&nbsp;        alreadySubmittedData.setMarksObtained(marksObtained);</b>
<b class="fc">&nbsp;        alreadySubmittedData.setSubmissionStatusId(submissionStatusDao.findByName(Constants.GRADED).getId());</b>
<b class="fc">&nbsp;        QuizSubmission updatedSubmission = quizSubmissionDao.save(alreadySubmittedData);</b>
<b class="fc">&nbsp;        JSONObject res = new JSONObject();</b>
<b class="fc">&nbsp;        res.put(&quot;message&quot;,&quot;Quiz graded successfully!&quot;);</b>
<b class="fc">&nbsp;        res.put(&quot;submission&quot;,updatedSubmission);</b>
&nbsp;
<b class="fc">&nbsp;        return res;</b>
&nbsp;    }
&nbsp;
&nbsp;    public JSONObject getModuleDetailsByModuleAndCourseId(int moduleId, int courseId, String authToken) {
<b class="nc">&nbsp;        final String uri = &quot;http://&quot; + Constants.AWS_IP + &quot;:8083/getModuleDetailsById?courseModuleId=&quot;+moduleId+&quot;&amp;courseId=&quot;+courseId;</b>
&nbsp;
<b class="nc">&nbsp;        RestTemplate restTemplate = new RestTemplate();</b>
<b class="nc">&nbsp;        HttpHeaders headers = new HttpHeaders();</b>
<b class="nc">&nbsp;        headers.add(&quot;Authorization&quot;, authToken);</b>
&nbsp;
<b class="nc">&nbsp;        logger.info(&quot;url token : {}&quot;,uri);</b>
&nbsp;
<b class="nc">&nbsp;        HttpEntity&lt;String&gt; entity = new HttpEntity&lt;&gt;(null, headers);</b>
&nbsp;
&nbsp;
&nbsp;        try {
<b class="nc">&nbsp;            ResponseEntity&lt;String&gt; res = restTemplate.exchange(uri, HttpMethod.GET, entity, String.class);</b>
<b class="nc">&nbsp;            String resBody = res.getBody();</b>
<b class="nc">&nbsp;            JSONObject jsonObject = new JSONObject(resBody);</b>
<b class="nc">&nbsp;            return jsonObject;</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            logger.error(&quot;Error in API for auth!&quot;);</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public JSONObject getUserDetailsFromUserId(int userId) {
<b class="fc">&nbsp;        final String uri = &quot;http://&quot; + Constants.AWS_IP + &quot;:8081/user-details?userId=&quot;+ userId;</b>
&nbsp;
<b class="fc">&nbsp;        RestTemplate restTemplate = new RestTemplate();</b>
<b class="fc">&nbsp;        HttpEntity&lt;String&gt; entity = new HttpEntity&lt;&gt;(null);</b>
&nbsp;
&nbsp;
&nbsp;        try {
<b class="fc">&nbsp;            ResponseEntity&lt;String&gt; res = restTemplate.exchange(uri, HttpMethod.GET, entity, String.class);</b>
<b class="nc">&nbsp;            String resBody = res.getBody();</b>
<b class="nc">&nbsp;            JSONObject jsonObject = new JSONObject(resBody);</b>
<b class="nc">&nbsp;            logger.info(&quot;response body : {}&quot;,jsonObject);</b>
<b class="nc">&nbsp;            return jsonObject;</b>
<b class="fc">&nbsp;        } catch (Exception e) {</b>
<b class="fc">&nbsp;            logger.error(&quot;Error in API for getting user details from userId!&quot;);</b>
<b class="fc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-11-30 14:26</div>
</div>
</body>
</html>
